## 问题描述
使用大彩的串口屏`DC80480CM043_1011_OC`，在其配套的上位机软件`VisualTFT`中进行UI界面开发时，遇到了文本和文字控件错位的问题。

比如，我想设计一个如下的界面：
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/想象的界面效果.png)

其中黑色字体为文字控件，作为框架显示。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/文字控件.png)

红色字体为文本控件，作为用户可输入或修改的值。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/文本控件.png)

同时两种控件都设置为`ASC_CHS_26`字体，即26号字。同时每个控件的位置都按照像素点详细计算。

但经过编译下载后会发现显示的效果与自己设计的效果相差很大，文字直接完全错开了。虚拟串口屏效果与实际显示效果一致，与工程完全不一样。这里放上虚拟串口屏显示的效果：
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/虚拟串口屏显示效果.png)

会发现好像不仅是文字错开了，整个文本控件的宽度也变窄了。但同时，最下边一行与其使用相同字体的`共服用……`一段话的宽度并没有发生变化，但仍与工程中设计的位置有所差距。通过以下两张画上辅助线的对比图就能看出来：
![对比图片1](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/对比图片1.png)

![对比图片2](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/图片/对比图片2.png)

很明显能看出来不仅文字控件和文本控件的位置出错了，就连文字控件的宽度也出现了问题。


## 问题分析
### 一
由于文本出现整体宽度变窄，所以初步怀疑是坐标设置错误或对齐方式错误导致，但检查确认过设置的坐标并将文字的对齐方式改为左对齐后，发现文字控件依然宽度变窄并且出现了整体的偏移，因此排除了坐标和对齐方式的问题。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310165535.png)

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310170743.png)


### 二
排除了坐标和对齐方式的问题后，发现第一行的文字和第二行的文字并没有出现错位或者宽度变化的问题，那么就考虑是否是因为其使用了不同的字体，而某个字体有BUG才导致的问题。现将`ASC_CHS_26`改为`ASC_CHS_28`，重新测试。发现错位的现象依然存在。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310171259.png)

那么就排除了`ASC_CHS_26`字体BUG导致问题的可能性。

### 三
那么既然不是选用字体的问题，也不是坐标或其他设置的问题，那么还能是哪出现的问题呢？

既然第一行文字没有出现这种问题，那么我就将出现问题的这个文字控件与没有出现问题的文字控件做对比，其中汉字两者都有，而空格和下划线却只出现在出问题的文字控件中。那么稍微进行测试，问题原因应该就明了了。

在常用的字库中，比如使用word文档、甚至在此问题所涉及到的`VisualTFT`软件中，大家默认两个数字或下划线等字符的宽度等于一个汉字的宽度，比如在本工程中：
使用`ASC_CHS_28`字体时，两个文字的宽度正好是56。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310172436.png)

而四个数字的宽度也是56，少一个像素点，数字就会有一位显示不出来。

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310172609.png)

下划线也是一样，少一个像素点就会显示不出来其中一个。
![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310172831.png)

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310172908.png)


那么在本工程中，出现问题的文字控件中有三行文字，那么我们将其中一行文字中的空格替换成汉字，一行文字中的下划线替换成汉字，出现以下结果。

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310173255.png)

很明显，将空格和下划线替换成汉字后，在虚拟串口屏和编译下载后都会出现文字偏移、上下无法对齐的情况。

那么就可以判断问题出现是因为**两个空格的宽度≠一个汉字的宽度**，**两个下划线的宽度≠一个汉字的宽度**。

## 深入分析
由于我个人也只是了解和偶尔使用字库，因此仅能做出一些猜测，无法明确问题出现的原因。
* 猜测1：VisualTFT调用Windows字库而串口屏使用官方提供的字库
* 猜测2：VisualTFT和串口屏使用相同字库，但串口屏将符号以ASCII码或其他字库和编码的形式显示
* 猜测3：官方提供的字库有问题
当重复运行虚拟串口屏时，会提示无法修改字库文件。

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310175343.png)

我们查询这个文件，发现这就是串口屏提供的字库，名叫`wen quan yi micro hei 文泉驿微米黑 ` ，同时我们能直接打开这个文件，发现这个字库中**不包含空格和下划线！！！！！**

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310175453.png)

在软件工具中，我发现了字库配置的选项。

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310180303.png)

将字库修改为宋体后，出现的问题消失了！！！

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310180353.png)

![](肥猫的小世界/肥猫的学习世界/串口屏/VisualTFT/Pasted%20image%2020250310180416.png)

因此可以确定，出现问题的原因就是官方提供的字库中不包含空格和下划线，导致串口屏将这两种符号以普通ASCII字符的形式显示。





## 解决方法

1. 更改工程的字库
2. 通过其他方法实现在一段文字中修改文本，避免使用空格等符号
3. 手动微调文本控件的位置，修正错位

